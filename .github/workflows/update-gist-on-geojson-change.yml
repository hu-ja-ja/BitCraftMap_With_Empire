name: Update Gist on GeoJSON change

on:
  push:
    branches: [main]
    paths:
      - "Resource/*.geojson"
  workflow_run:
    workflows: ["Daily Map Update"]
    types:
      - completed

jobs:
  update-gist:
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 35
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Check for default color in YAML
        id: check_color
        run: |
          YAML_FILE="Resource/color_map.yaml"
          DEFAULT_COLOR="#FF5500ff"

          if [ ! -f "$YAML_FILE" ]; then
            echo "Warning: $YAML_FILE not found. Skipping Gist update."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if grep -q "$DEFAULT_COLOR" "$YAML_FILE"; then
            echo "Default color ($DEFAULT_COLOR) found in $YAML_FILE."
            echo "Skipping Gist update."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Default color not found. Proceeding with Gist update."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Gist for changed GeoJSON files
        if: steps.check_color.outputs.skip != 'true'
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
          BEFORE: ${{ github.event.before }}
          SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
        run: |
          python - <<'PY'
          import os, subprocess, json, sys, urllib.request, glob

          before = os.environ.get('BEFORE')
          sha = os.environ.get('SHA')
          token = os.environ.get('GIST_TOKEN')
          gist_id = os.environ.get('GIST_ID')

          if not token or not gist_id:
              print("GIST_TOKEN or GIST_ID not set; aborting")
              sys.exit(1)

          changed = []
          try:
              if before and not set(before) <= set('0'):
                  out = subprocess.check_output(['git','diff','--name-only', before, sha, '--', 'Resource/*.geojson'], stderr=subprocess.DEVNULL).decode().splitlines()
                  changed = [p.strip() for p in out if p.strip()]
              else:
                  changed = glob.glob('Resource/*.geojson')
          except subprocess.CalledProcessError:
              changed = []

          if not changed:
              print('No changed Resource/*.geojson files detected.')
              sys.exit(0)

          files_payload = {}
          for path in changed:
              name = os.path.basename(path)
              try:
                  with open(path, 'r', encoding='utf-8') as f:
                      content = f.read()
              except Exception as e:
                  print('Failed reading', path, e)
                  continue
              files_payload[name] = {"content": content}

          if not files_payload:
              print('No files to update.')
              sys.exit(0)

          payload = {"files": files_payload}
          data = json.dumps(payload).encode('utf-8')
          req = urllib.request.Request(f"https://api.github.com/gists/{gist_id}", data=data, headers={
              "Authorization": f"token {token}",
              "User-Agent": "BitCraftMap_With_Empire",
              "Content-Type": "application/json",
          }, method="PATCH")

          try:
              with urllib.request.urlopen(req) as resp:
                  resp_data = resp.read().decode()
                  j = json.loads(resp_data)
                  print('Gist updated:', j.get('html_url'))
          except urllib.error.HTTPError as e:
              print('Gist update failed:', e.code, e.read().decode())
              sys.exit(1)
          PY
